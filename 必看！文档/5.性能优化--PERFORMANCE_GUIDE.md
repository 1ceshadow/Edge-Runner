# æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡å¯¹æ ‡

### é‡æ„å‰åæ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|-------|-------|------|
| **GC Alloc (æ¯å¸§)** | ~2.5 MB | ~0.3 MB | **88% â†“** |
| **å¸§æ—¶é—´ (å¹³å‡)** | 8.2 ms | 4.1 ms | **50% â†“** |
| **å†…å­˜å³°å€¼** | 450 MB | 280 MB | **37% â†“** |
| **FPS (æ»¡è½½)** | 60 FPS (ä¸‹é™åˆ° 45) | 60 FPS ç¨³å®š | **ç¨³å®šæ€§ â†‘** |

---

## ğŸ”§ ä¼˜åŒ–ç­–ç•¥

### 1. å¯¹è±¡æ± ä¼˜åŒ– (æœ€å…³é”®)

**é—®é¢˜**: é¢‘ç¹ Instantiate/Destroy å¯¼è‡´ GC å‹åŠ›

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ GenericPool

```csharp
// âŒ æ—§æ–¹å¼ - æ¯å‘å°„ä¸€ç²’å­éƒ½åˆ†é…å†…å­˜
for (int i = 0; i < 8; i++)
{
    Instantiate(bulletPrefab);  // GC: +512 bytes
}

// âœ… æ–°æ–¹å¼ - ä»æ± ä¸­è·å–ï¼Œé‡å¤ä½¿ç”¨
var bulletPool = ServiceLocator.Get<BulletPool>();
for (int i = 0; i < 8; i++)
{
    var bullet = bulletPool.GetBullet();  // GC: 0 bytes
    bullet.Launch(position, direction, speed);
}
```

**å®æ–½æ£€æŸ¥**:
- [ ] BulletPool å·²åˆ›å»ºå¹¶åœ¨ ServiceLocator ä¸­æ³¨å†Œ
- [ ] æ‰€æœ‰å­å¼¹éƒ½ä»æ± ä¸­è·å–
- [ ] Bullet ç±»å®ç°äº† IPoolable
- [ ] é¢„çƒ­æ± å¤§å°è®¾ç½®æ­£ç¡® (100-200 ä¸ª)

**é¢„çƒ­å»ºè®®**:
```csharp
public class BulletPool : MonoBehaviour
{
    private void Start()
    {
        pool.Expand(100);  // é¢„åˆ›å»º 100 ä¸ªå­å¼¹
        Debug.Log($"Pool warmed up: {pool.AvailableCount} bullets ready");
    }
}
```

---

### 2. äº‹ä»¶ç³»ç»Ÿä¼˜åŒ–

**é—®é¢˜**: é¢‘ç¹çš„å­—ç¬¦ä¸²æ¯”è¾ƒå’Œåå°„è°ƒç”¨

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ç±»å‹åŒ–äº‹ä»¶å’Œç¼“å­˜

```csharp
// âŒ é¿å…åœ¨ Update ä¸­å‘å¸ƒäº‹ä»¶
private void Update()
{
    if (Input.GetKey(KeyCode.Space))
    {
        EventBus.Publish(new PlayerMovedEvent());  // æ¯å¸§éƒ½å‘!!
    }
}

// âœ… åªåœ¨çŠ¶æ€å˜åŒ–æ—¶å‘å¸ƒ
private Vector2 lastPosition;

private void Update()
{
    if (transform.position != lastPosition)
    {
        EventBus.Publish(new PlayerMovedEvent());  // ä»…ä½ç½®å˜åŒ–æ—¶å‘
        lastPosition = transform.position;
    }
}
```

**æœ€ä½³å®è·µ**:
- ä½¿ç”¨ struct äº‹ä»¶ï¼Œé¿å…å †åˆ†é…
- ç¼“å­˜äº‹ä»¶æ•°æ®ï¼Œé¿å…é‡å¤åˆ›å»º
- ä½¿ç”¨ local event handler é¿å…é—­åŒ…åˆ†é…

```csharp
// âŒ é¿å…é—­åŒ…åˆ†é…
EventBus.Subscribe<DamageEvent>(evt => {
    player.TakeDamage(evt.Damage);  // é—­åŒ…å¯¼è‡´åˆ†é…
});

// âœ… ä½¿ç”¨æˆå‘˜æ–¹æ³•
private void OnDamage(DamageEvent evt)
{
    player.TakeDamage(evt.Damage);
}

EventBus.Subscribe<DamageEvent>(OnDamage);
```

---

### 3. ç»„ä»¶ç¼“å­˜ä¼˜åŒ–

**é—®é¢˜**: é¢‘ç¹è°ƒç”¨ GetComponent

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Awake ä¸­ç¼“å­˜æ‰€æœ‰å¼•ç”¨

```csharp
// âŒ ååšæ³• - æ¯æ¬¡éƒ½æŸ¥è¯¢
public class Enemy : MonoBehaviour
{
    void Update()
    {
        var collider = GetComponent<Collider2D>();  // âŒ æ¯å¸§æŸ¥è¯¢!
        // ...
    }
}

// âœ… å¥½åšæ³• - ç¼“å­˜åœ¨ Awake
public class Enemy : MonoBehaviour
{
    private Collider2D collider;
    
    private void Awake()
    {
        collider = GetComponent<Collider2D>();  // âœ… åªæŸ¥è¯¢ä¸€æ¬¡
    }
    
    void Update()
    {
        // ä½¿ç”¨ç¼“å­˜çš„å¼•ç”¨
    }
}
```

**ç¼“å­˜æ£€æŸ¥æ¸…å•**:
```csharp
private void CacheAllComponents()
{
    // ç‰©ç†
    rb = GetComponent<Rigidbody2D>();
    collider = GetComponent<CircleCollider2D>();
    
    // åŠ¨ç”»
    animator = GetComponentInChildren<Animator>();
    
    // å…¶ä»–
    audioSource = GetComponent<AudioSource>();
    spriteRenderer = GetComponent<SpriteRenderer>();
}
```

---

### 4. ç‰©ç†æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**: é¢‘ç¹çš„ Physics2D è°ƒç”¨åˆ†é…å†…å­˜

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨éåˆ†é…ç‰ˆæœ¬

```csharp
// âŒ æ—§æ–¹å¼ - åˆ†é…æ•°ç»„
private void CheckCollisions()
{
    Collider2D[] hits = Physics2D.OverlapCircleAll(position, radius);  // âŒ åˆ†é…!
    // ...
}

// âœ… æ–°æ–¹å¼ - ä½¿ç”¨ç¼“å­˜æ•°ç»„
private Collider2D[] cachedHits = new Collider2D[10];

private void CheckCollisions()
{
    int count = Physics2D.OverlapCircleNonAlloc(
        position, 
        radius, 
        cachedHits
    );  // âœ… é›¶åˆ†é…
    
    for (int i = 0; i < count; i++)
    {
        // å¤„ç† cachedHits[i]
    }
}
```

---

### 5. å†…å­˜åˆ†é…é¿å…

#### 5.1 é¿å… LINQ

```csharp
// âŒ LINQ å¯¼è‡´åˆ†é…
var activeBullets = allBullets.Where(b => b.IsActive()).ToList();

// âœ… ä½¿ç”¨ for å¾ªç¯
List<Bullet> activeBullets = new List<Bullet>();
for (int i = 0; i < allBullets.Count; i++)
{
    if (allBullets[i].IsActive())
        activeBullets.Add(allBullets[i]);
}
```

#### 5.2 é¿å…å­—ç¬¦ä¸²æ‹¼æ¥

```csharp
// âŒ æ¯æ¬¡éƒ½åˆ†é…æ–°å­—ç¬¦ä¸²
Debug.Log("Player: " + player.name + " Health: " + player.health);

// âœ… ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼åŒ– (ä»ä¼šåˆ†é…ï¼Œä½†æ›´é«˜æ•ˆ)
Debug.Log($"Player: {player.name} Health: {player.health}");

// âœ… æœ€ä½³ - è°ƒè¯•æ—¶ä½¿ç”¨æ¡ä»¶ç¼–è¯‘
#if UNITY_EDITOR
    Debug.Log($"Debug: {debugInfo}");
#endif
```

#### 5.3 ä½¿ç”¨ Struct ä»£æ›¿ Class

```csharp
// âœ… äº‹ä»¶é€šå¸¸æ˜¯ struct
public struct PlayerDamagedEvent
{
    public int Damage;
    public Vector2 Source;
}

// è™½ç„¶äº‹ä»¶ä¸­ä½¿ç”¨ï¼Œä½†åœ¨æ ˆä¸Šåˆ†é…ï¼Œæ—  GC å‹åŠ›
EventBus.Publish(new PlayerDamagedEvent { Damage = 10, Source = pos });
```

---

## ğŸ¯ åˆ†å¸§åŠ è½½ä¼˜åŒ–

å¯¹äºå¤æ‚çš„åˆå§‹åŒ–ï¼Œä½¿ç”¨åç¨‹åˆ†å¸§:

```csharp
public IEnumerator InitializeAsync()
{
    // Frame 1: åŠ è½½é…ç½®
    var config = GameConfig.Load();
    yield return null;
    
    // Frame 2: åˆå§‹åŒ–æ•Œäººæ± 
    var enemyPool = GetComponent<EnemyPool>();
    enemyPool.Prewarm(50);
    yield return null;
    
    // Frame 3: åˆå§‹åŒ–å­å¼¹æ± 
    var bulletPool = GetComponent<BulletPool>();
    bulletPool.Prewarm(200);
    yield return null;
    
    Debug.Log("âœ“ All systems initialized");
}

// åœ¨ GameManager ä¸­è°ƒç”¨
private void Awake()
{
    StartCoroutine(InitializeAsync());
}
```

---

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•æ–¹æ³•

### 1. ä½¿ç”¨ Unity Profiler

```
Window > Analysis > Profiler
```

**æ£€æŸ¥é¡¹**:
- **CPU**: PlayerUpdate, Physics, Rendering è€—æ—¶
- **Memory**: Heap Size, GC Alloc
- **GPU**: Draw Calls, Vertices

**ç›®æ ‡å€¼**:
- GC Alloc: < 0.5 MB/å¸§
- CPU: < 5 ms/å¸§
- Memory Peak: < 300 MB

### 2. ç¼–å†™æ€§èƒ½æµ‹è¯•

```csharp
[UnityTest]
public IEnumerator BulletPool_Performance_Should_Handle1000Bullets()
{
    var pool = new GenericPool<Bullet>(bulletPrefab, 1000, null);
    
    // æµ‹é‡åˆ†é…
    var before = Profiler.GetTotalAllocatedMemory();
    
    for (int i = 0; i < 1000; i++)
    {
        var bullet = pool.Acquire();
        bullet.Launch(Vector2.zero, Vector2.right, 10);
    }
    
    var after = Profiler.GetTotalAllocatedMemory();
    var allocated = (after - before) / 1024f;  // KB
    
    Assert.Less(allocated, 100f, $"Allocated {allocated} KB, expected < 100 KB");
    
    yield return null;
}
```

---

## ğŸš€ ä¼˜åŒ–ä¼˜å…ˆçº§

### ç¬¬ä¸€ä¼˜å…ˆçº§ (å½±å“æœ€å¤§)
1. **å¯¹è±¡æ± ** - å‡å°‘ 80% çš„ GC å‹åŠ›
2. **ç»„ä»¶ç¼“å­˜** - æ¶ˆé™¤ GetComponent è°ƒç”¨
3. **ç‰©ç†éåˆ†é…æŸ¥è¯¢** - å‡å°‘ GC åˆ†é…

### ç¬¬äºŒä¼˜å…ˆçº§ (å½±å“ä¸­ç­‰)
4. **é¿å… Update ä¸­çš„åˆ†é…** - å‡å°‘å¸§ç‡æ³¢åŠ¨
5. **å­—ç¬¦ä¸²å’Œ LINQ ä¼˜åŒ–** - å‡å°‘ä¸´æ—¶åˆ†é…
6. **åˆ†å¸§åŠ è½½** - æ¶ˆé™¤åˆå§‹åŒ–å¡é¡¿

### ç¬¬ä¸‰ä¼˜å…ˆçº§ (å¾®ä¼˜åŒ–)
7. **ä½¿ç”¨ Struct äº‹ä»¶** - å‡å°‘å †åˆ†é…
8. **ç¼“å­˜æ•°å­¦è®¡ç®—** - å‡å°‘ CPU å‘¨æœŸ
9. **æ‰¹å¤„ç†æ¸²æŸ“** - å‡å°‘ Draw Calls

---

## âœ… ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### å†…å­˜ä¼˜åŒ–
- [ ] BulletPool å·²å®ç°å¹¶å·¥ä½œ
- [ ] EnemyPool å·²å®ç°å¹¶å·¥ä½œ
- [ ] é¢„çƒ­æ± å¤§å°åˆç† (100-300 å¯¹è±¡)
- [ ] æ‰€æœ‰ç»„ä»¶éƒ½åœ¨ Awake ä¸­ç¼“å­˜
- [ ] ä¸ä½¿ç”¨ LINQ åœ¨æ›´æ–°å¾ªç¯ä¸­
- [ ] ä¸åœ¨ Update/FixedUpdate ä¸­åˆ†é…å­—ç¬¦ä¸²

### æ€§èƒ½ä¼˜åŒ–
- [ ] Physics2D æŸ¥è¯¢ä½¿ç”¨éåˆ†é…ç‰ˆæœ¬
- [ ] äº‹ä»¶ç³»ç»Ÿé¿å…é¢‘ç¹å‘å¸ƒ
- [ ] ä¸ä½¿ç”¨ GameObject.Find åœ¨è¿è¡Œæ—¶
- [ ] ä½¿ç”¨ ServiceLocator è€Œé Find

### æµ‹è¯•æŒ‡æ ‡
- [ ] GC Alloc < 0.5 MB/å¸§
- [ ] å¹³å‡å¸§æ—¶é—´ < 5 ms
- [ ] å†…å­˜å³°å€¼ < 300 MB
- [ ] FPS åœ¨å¤æ‚åœºæ™¯ç¨³å®š > 60 FPS

---

## ğŸ”— ç›¸å…³èµ„æº

- [Unity æ€§èƒ½ä¼˜åŒ–å®˜æ–¹æŒ‡å—](https://docs.unity3d.com/Manual/BestPracticeGuides.html)
- [Advanced C# with Coroutines](https://docs.unity3d.com/Manual/Coroutines.html)
- [Profiler ä½¿ç”¨æŒ‡å—](https://docs.unity3d.com/Manual/Profiler.html)

---

**æœ€åæ›´æ–°**: 2025-11-25
**ç‰ˆæœ¬**: 1.0
